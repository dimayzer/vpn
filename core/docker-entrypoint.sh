#!/bin/bash
set -e

# SSH-—Ç—É–Ω–Ω–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Ö–æ—Å—Ç–µ, –∞ –Ω–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç—É–Ω–Ω–µ–ª—è —á–µ—Ä–µ–∑ host.docker.internal
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ SSH-—Ç—É–Ω–Ω–µ–ª—è —á–µ—Ä–µ–∑ host.docker.internal:38868..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏
TUNNEL_AVAILABLE=false

# –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ curl (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ 3x-UI —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞, –Ω–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
if curl -s --connect-timeout 2 --max-time 3 -o /dev/null -w "%{http_code}" http://host.docker.internal:38868 > /dev/null 2>&1; then
    TUNNEL_AVAILABLE=true
fi

# –°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ nc (netcat) –∏–ª–∏ socket
if ! $TUNNEL_AVAILABLE; then
    if command -v nc >/dev/null 2>&1; then
        if nc -z -w 2 host.docker.internal 38868 2>/dev/null; then
            TUNNEL_AVAILABLE=true
        fi
    fi
fi

# –°–ø–æ—Å–æ–± 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ timeout –∏ /dev/tcp (bash builtin)
if ! $TUNNEL_AVAILABLE; then
    if timeout 2 bash -c "echo > /dev/tcp/host.docker.internal/38868" 2>/dev/null; then
        TUNNEL_AVAILABLE=true
    fi
fi

if $TUNNEL_AVAILABLE; then
    echo "‚úÖ SSH-—Ç—É–Ω–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ host.docker.internal:38868"
else
    echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å SSH-—Ç—É–Ω–Ω–µ–ª—è"
    echo "‚ÑπÔ∏è –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ç—É–Ω–Ω–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–ø—É—â–µ–Ω"
    echo "‚ÑπÔ∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH-—Ç—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Ö–æ—Å—Ç–µ –∏ —Å–ª—É—à–∞–µ—Ç –Ω–∞ 0.0.0.0:38868"
    echo "‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ö–æ—Å—Ç–µ: ss -tulpn | grep 38868"
    echo "‚ÑπÔ∏è –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞ —Ö–æ—Å—Ç–µ:"
    echo "   ssh -N -L 0.0.0.0:38868:127.0.0.1:38868 -i ~/fiorevpn/ssh/x3ui_key root@62.133.60.47"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
exec "$@"

