<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <link rel="icon" type="image/png" href="/static/images/logo.png">
    <link rel="shortcut icon" type="image/png" href="/static/images/logo.png">
    <link rel="stylesheet" href="/static/loading.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.2));
            animation: pulseLogo 3s ease-in-out infinite;
        }
        @keyframes pulseLogo {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.95; }
        }
        .header a {
            color: white;
            text-decoration: none;
            padding: 8px 14px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .section {
            padding: 24px 28px;
            border-bottom: 1px solid #f1f3f5;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }
        .card {
            background: #f8f9fb;
            border-radius: 10px;
            padding: 14px 16px;
            border: 1px solid #eef1f5;
        }
        .label {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        .value {
            font-weight: 600;
            color: #333;
        }
        .value-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .btn {
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-primary { background: #667eea; color: white; }
        .btn-muted { background: #e9ecef; color: #333; text-decoration:none; display:inline-block; }
        .input {
            padding: 8px 10px;
            border: 1px solid #e1e5ea;
            border-radius: 8px;
            font-size: 0.9em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #f1f3f5;
            text-align: left;
            font-size: 0.9em;
        }
        th { color: #666; }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 700;
        }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-inactive { background: #f8d7da; color: #721c24; }
        .badge-admin { background: #fff3cd; color: #856404; }
        .badge-user { background: #d1ecf1; color: #0c5460; }
        .badge-payment-success { background: #d4edda; color: #155724; }
        .badge-payment-pending { background: #fff3cd; color: #856404; }
        .badge-payment-failed { background: #f8d7da; color: #721c24; }
        .row-payment-success { background: #f0f9f4; border-left: 3px solid #28a745; }
        .row-payment-pending { background: #fffbf0; border-left: 3px solid #ffc107; }
        .row-payment-failed { background: #fff5f5; border-left: 3px solid #dc3545; }
        .muted { color: #777; font-size: 0.9em; }
        .notice {
            padding: 10px 12px;
            background: #fff3cd;
            color: #856404;
            border-radius: 10px;
            border: 1px solid #ffeeba;
            margin-bottom: 14px;
        }
        /* Modal */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 22px;
            width: min(440px, 92vw);
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }
        .modal h3 {
            margin: 0 0 12px;
        }
        .modal .actions {
            justify-content: flex-end;
        }
        body.backdrop-blur .container {
            filter: blur(4px);
        }
        .clickable {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-brand">
                <img src="/static/images/logo.png" alt="fioreVPN" class="header-logo" onerror="this.style.display='none';">
                <div>
                    <div style="font-size:1.4em; font-weight:700;">üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                    <div style="opacity:0.9;">tg_id: {{ user.tg_id }}</div>
                </div>
            </div>
            </div>
            <div class="actions">
                <a class="btn-muted" href="/admin/web/users">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
                <a class="btn-muted" href="/admin/logout">üö™ –í—ã–π—Ç–∏</a>
            </div>
        </div>

        <div class="section">
            {% if request.query_params.get('error') %}
            <div class="notice">
                {% set err = request.query_params.get('error') %}
                {% if err == 'bad_amount' %}–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞. –í–≤–æ–¥–∏ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: <code>10</code> –∏–ª–∏ <code>10.5</code>.
                {% elif err == 'forbidden_rank' %}–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤: –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å —Ä–∞–≤–Ω–æ–π/–±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–π —Ä–æ–ª—å—é.
                {% elif err == 'forbidden_self' %}–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ —Ä–æ–ª—å –∏–ª–∏ –±–∞–Ω.
                {% elif err == 'reason_required' %}–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É.
                {% else %}–û—à–∏–±–∫–∞: {{ err }}{% endif %}
            </div>
            {% endif %}
            <div class="grid">
                <div class="card">
                    <div class="label">–ê–≤–∞—Ç–∞—Ä</div>
                    {% if avatar_url %}
                    <div class="value"><img src="{{ avatar_url }}" alt="avatar" style="width:96px; height:96px; border-radius:12px; object-fit:cover; border:1px solid #eef1f5;"></div>
                    {% else %}
                    <div class="value muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    {% endif %}
                </div>
                <div class="card">
                    <div class="label">–ò–º—è</div>
                    <div class="value">{{ user.first_name }} {{ user.last_name }}</div>
                </div>
                <div class="card">
                    <div class="label">–¢–µ–≥</div>
                    <div class="value">
                        {% if user.username %}
                        <a href="https://t.me/{{ user.username }}" target="_blank" style="color:#667eea; text-decoration:none;">@{{ user.username }}</a>
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </div>
                </div>
                <div class="card">
                    <div class="label">–†–æ–ª—å</div>
                    <div class="value-inline clickable" data-modal-target="modal-role">
                        <span class="badge {% if user.role == '–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω' %}badge-admin{% elif user.role == '–ê–¥–º–∏–Ω' %}badge-admin{% elif user.role == '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' %}badge-user{% else %}badge-user{% endif %}">{{ user.role }}</span>
                        <div class="muted" style="margin-top:4px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</div>
                    </div>
                </div>
                <div class="card">
                    <div class="label">–ë–∞–ª–∞–Ω—Å</div>
                    <div class="value-inline clickable" data-modal-target="modal-balance">
                        <span>{{ "%.2f"|format(user.balance) }} RUB</span>
                        <div class="muted" style="margin-top:4px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</div>
                    </div>
                </div>
                <div class="card">
                    <div class="label">–°—Ç–∞—Ç—É—Å</div>
                    <div class="value-inline clickable" data-modal-target="modal-status">
                        <span class="badge {% if user.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                            {% if user.is_active %}‚úÖ –ê–∫—Ç–∏–≤–µ–Ω{% else %}‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω{% endif %}
                        </span>
                        <div class="muted" style="margin-top:4px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</div>
                    </div>
                </div>
                <div class="card">
                    <div class="label">–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</div>
                    <div class="value-inline clickable" data-modal-target="modal-subscription">
                        <span class="badge {% if user.has_active_subscription %}badge-active{% else %}badge-inactive{% endif %}">
                            {% if user.has_active_subscription %}‚úÖ –ï—Å—Ç—å{% else %}‚ùå –ù–µ—Ç{% endif %}
                        </span>
                        <div class="muted" style="margin-top:4px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</div>
                    </div>
                </div>
                {% if user.has_active_subscription and user.subscription_ends_at %}
                <div class="card">
                    <div class="label">–ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</div>
                    <div class="value">{{ user.subscription_ends_at }} –ú–°–ö</div>
                </div>
                {% endif %}
                <div class="card">
                    <div class="label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                    <div class="value">{{ user.created_at }} –ú–°–ö</div>
                </div>
                <div class="card">
                    <div class="label">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</div>
                    <div class="value"><code>{{ user.referral_code }}</code></div>
                </div>
                <div class="card">
                    <div class="label">–ü—Ä–∏–≥–ª–∞—Å–∏–ª</div>
                    <div class="value">
                        {% if user.referred_by_tg_id %}
                        <a href="/admin/web/users/{{ user.referred_by_tg_id }}" style="color:#667eea; text-decoration:none;">{{ user.referred_by_tg_id }}</a>
                        {% else %}‚Äî{% endif %}
                    </div>
                </div>
                <div class="card">
                    <div class="label">–ü—Ä–∏–≥–ª–∞—Å–∏–ª —Å–∞–º (—Ä–µ—Ñ–µ—Ä–∞–ª—ã)</div>
                    <div class="value">{{ referrals_count }}</div>
                </div>
                <div class="card">
                    <div class="label">–¢–∏–∫–µ—Ç—ã</div>
                    <div class="value-inline clickable" data-modal-target="modal-tickets">
                        <span>{{ tickets|length if tickets else 0 }}</span>
                        <div class="muted" style="margin-top:4px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
                    </div>
                </div>
                <div class="card">
                    <div class="label">–ü–ª–∞—Ç–µ–∂–∏</div>
                    <div class="value-inline clickable" data-modal-target="modal-payments">
                        <span id="payments-count">‚Äî</span>
                        <div class="muted" style="margin-top:4px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="logs-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                <h3 style="margin:0;">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</h3>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <select id="logs-filter-action" onchange="applyLogsFilter()" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.9em;">
                        <option value="all">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
                        <option value="user_blocked">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</option>
                        <option value="user_unblocked">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</option>
                        <option value="balance_credited">–ò–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞</option>
                        <option value="role_changed">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏</option>
                        <option value="ticket_created">–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤</option>
                        <option value="admin_action">–ê–¥–º–∏–Ω –¥–µ–π—Å—Ç–≤–∏—è</option>
                    </select>
                    <button class="btn btn-muted" onclick="exportUserLogs()" style="padding:6px 12px; font-size:0.9em;">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                </div>
            </div>
            <div id="logs-container">
                {% if logs %}
                <table id="logs-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th>–ê–¥–º–∏–Ω</th>
                            <th>–î–µ—Ç–∞–ª–∏</th>
                            <th>–í—Ä–µ–º—è (–ú–°–ö)</th>
                        </tr>
                    </thead>
                    <tbody id="logs-tbody">
                        {% for log in logs %}
                        {% set is_critical = log.action in ['user_blocked', 'user_unblocked', 'balance_credited', 'role_changed'] %}
                        {% set is_warning = log.action in ['ticket_created', 'subscription_created'] %}
                        <tr class="{% if is_critical %}log-row-critical{% elif is_warning %}log-row-warning{% endif %}">
                            <td>{{ log.id }}</td>
                            <td>
                                <span class="badge {% if is_critical %}badge-critical{% elif is_warning %}badge-warning{% else %}badge-info{% endif %}">
                                    {{ log.action }}
                                </span>
                            </td>
                            <td>{{ log.admin_tg_id or '‚Äî' }}</td>
                            <td>{{ log.details or '‚Äî' }}</td>
                            <td>{{ log.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="logs-pagination" style="margin-top:12px; display:flex; gap:8px;">
                    {% if logs_has_prev %}
                    <button class="btn btn-muted" onclick="loadLogsPage({{ logs_page - 1 }})">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                    {% endif %}
                    {% if logs_has_next %}
                    <button class="btn btn-muted" onclick="loadLogsPage({{ logs_page + 1 }})">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
                    {% endif %}
                </div>
                {% else %}
                <div class="muted" id="logs-empty">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Overlay Modals -->
    <div class="overlay" id="modal-role">
        <div class="modal">
            <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>
            {% if is_protected_admin %}
                <p class="muted">–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω –∏–∑ ADMIN_IDS ‚Äî —Ä–æ–ª—å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.</p>
                <div class="actions" style="margin-top:12px;">
                    <button class="btn btn-muted" type="button" onclick="closeModal('modal-role')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            {% else %}
            <form method="post" action="/admin/web/users/role" class="modal-form">
                <input type="hidden" name="tg_id" value="{{ user.tg_id }}">
                <label class="label" style="display:block; margin-bottom:6px;">–†–æ–ª—å</label>
                <select class="input" name="role" style="width:100%; margin-bottom:10px;">
                    {% for r in role_options %}
                    <option value="{{ r }}" {% if role_value == r %}selected{% endif %}>{{ '–ê–¥–º–∏–Ω' if r=='admin' else ('–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' if r=='moderator' else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å') }}</option>
                    {% endfor %}
                </select>
                <label class="label" style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞</label>
                <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑.)" style="width:100%; margin-bottom:14px;">
                <div class="actions">
                    <button class="btn btn-muted" type="button" onclick="closeModal('modal-role')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <div class="overlay" id="modal-balance">
        <div class="modal">
            <h3>–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
            <form method="post" action="/admin/web/users/credit" class="modal-form">
                <input type="hidden" name="tg_id" value="{{ user.tg_id }}">
                <label class="label" style="display:block; margin-bottom:6px;">–°—É–º–º–∞ (RUB)</label>
                <input class="input" type="text" name="amount" placeholder="+/- RUB" style="width:100%; margin-bottom:10px;">
                <label class="label" style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞</label>
                <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑.)" style="width:100%; margin-bottom:14px;">
                <div class="actions">
                    <button class="btn btn-muted" type="button" onclick="closeModal('modal-balance')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="modal-status">
        <div class="modal">
            <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
            {% if user.is_active %}
            <form method="post" action="/admin/web/users/block" class="modal-form">
                <input type="hidden" name="tg_id" value="{{ user.tg_id }}">
                <label class="label" style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</label>
                <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑.)" style="width:100%; margin-bottom:14px;">
                <div class="actions">
                    <button class="btn btn-muted" type="button" onclick="closeModal('modal-status')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-danger" type="submit">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </form>
            {% else %}
            <form method="post" action="/admin/web/users/unblock" class="modal-form">
                <input type="hidden" name="tg_id" value="{{ user.tg_id }}">
                <label class="label" style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</label>
                <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑.)" style="width:100%; margin-bottom:14px;">
                <div class="actions">
                    <button class="btn btn-muted" type="button" onclick="closeModal('modal-status')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-success" type="submit">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <div class="overlay" id="modal-tickets">
        <div class="modal" style="width: min(800px, 95vw); max-height: 90vh; overflow-y: auto;">
            <h3>–¢–∏–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            {% if tickets %}
            <table style="margin-top: 12px;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–¢–µ–º–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°–æ–∑–¥–∞–Ω</th>
                        <th>–û–±–Ω–æ–≤–ª—ë–Ω</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickets %}
                    <tr class="clickable" style="cursor:pointer;" onclick="window.location.href='/admin/web/tickets/{{ t.id }}'">
                        <td>{{ t.id }}</td>
                        <td>{{ t.topic }}</td>
                        <td>
                            <span class="badge {% if t.status == 'new' %}badge-active{% elif t.status == 'in_progress' %}badge-admin{% else %}badge-inactive{% endif %}">
                                {% if t.status == 'new' %}–°–æ–∑–¥–∞–Ω{% elif t.status == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ{% else %}–ó–∞–∫—Ä—ã—Ç{% endif %}
                            </span>
                        </td>
                        <td>{{ t.created_at }}</td>
                        <td>{{ t.updated_at }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="muted" style="margin-top: 12px;">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤</div>
            {% endif %}
            <div class="actions" style="margin-top: 16px; justify-content: flex-end;">
                <button class="btn btn-muted" type="button" onclick="closeModal('modal-tickets')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="modal-payments">
        <div class="modal" style="width: min(900px, 95vw); max-height: 90vh; overflow-y: auto;">
            <h3>–ü–ª–∞—Ç–µ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <div id="payments-container" style="margin-top: 12px;">
                <div class="muted" style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="actions" style="margin-top: 16px; justify-content: flex-end;">
                <button class="btn btn-muted" type="button" onclick="closeModal('modal-payments')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="modal-payment-detail">
        <div class="modal" style="width: min(600px, 95vw); max-height: 90vh; overflow-y: auto;">
            <h3>–î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞</h3>
            <div id="payment-detail-content" style="margin-top: 12px;">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="actions" style="margin-top: 16px; justify-content: flex-end;">
                <button class="btn btn-muted" type="button" onclick="closeModal('modal-payment-detail')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="modal-subscription">
        <div class="modal">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</h3>
            <form id="subscription-form" class="modal-form">
                <input type="hidden" name="tg_id" value="{{ user.tg_id }}">
                <label class="label" style="display:block; margin-bottom:6px;">–î–µ–π—Å—Ç–≤–∏–µ</label>
                <select class="input" name="action" id="subscription-action" style="width:100%; margin-bottom:14px;" onchange="updateSubscriptionForm()" required>
                    <option value="add">–í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</option>
                    <option value="extend">–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</option>
                    <option value="remove">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</option>
                </select>
                <div id="subscription-duration-group" style="margin-bottom:14px;">
                    <label class="label" style="display:block; margin-bottom:6px;">–°—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–Ω–µ–π)</label>
                    <input class="input" type="number" name="days" id="subscription-days" min="1" max="9999" value="30" placeholder="30" style="width:100%;" required>
                    <small style="color:#666; font-size:0.9em;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–æ—Ç 1 –¥–æ 9999 –¥–Ω–µ–π)</small>
                </div>
                <div id="subscription-reason-group" style="margin-bottom:14px;">
                    <label class="label" style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞</label>
                    <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –≤—ã–¥–∞—á–∏/–ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏" style="width:100%;" required>
                </div>
                <div class="actions">
                    <button class="btn btn-muted" type="button" onclick="closeModal('modal-subscription')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" type="submit" id="subscription-submit-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // CSRF –¥–ª—è –≤—Å–µ—Ö POST —Ñ–æ—Ä–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const csrfToken = "{{ csrf_token }}";
        document.querySelectorAll('form[method="post"]').forEach((form) => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    body: fd,
                    headers: { 'X-CSRF-Token': csrfToken }
                }).then(() => window.location.reload());
            });
        });

        // –ú–æ–¥–∞–ª–∫–∏
        function openModal(id) {
            document.body.classList.add('backdrop-blur');
            const ov = document.getElementById(id);
            if (ov) ov.classList.add('show');
        }
        function closeModal(id) {
            document.body.classList.remove('backdrop-blur');
            const ov = document.getElementById(id);
            if (ov) ov.classList.remove('show');
        }
        document.querySelectorAll('[data-modal-target]').forEach(el => {
            el.addEventListener('click', () => {
                const id = el.getAttribute('data-modal-target');
                if (id) openModal(id);
            });
        });
        document.querySelectorAll('.overlay').forEach(ov => {
            ov.addEventListener('click', (e) => {
                if (e.target === ov) {
                    ov.classList.remove('show');
                    document.body.classList.remove('backdrop-blur');
                }
            });
        });
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
        function updateSubscriptionForm() {
            const action = document.getElementById('subscription-action').value;
            const durationGroup = document.getElementById('subscription-duration-group');
            const reasonGroup = document.getElementById('subscription-reason-group');
            const submitBtn = document.getElementById('subscription-submit-btn');
            
            if (action === 'remove') {
                durationGroup.style.display = 'none';
                reasonGroup.querySelector('input').required = true;
                submitBtn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
                submitBtn.className = 'btn btn-danger';
            } else {
                durationGroup.style.display = 'block';
                reasonGroup.querySelector('input').required = true;
                if (action === 'add') {
                    submitBtn.textContent = '–í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
                } else {
                    submitBtn.textContent = '–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
                }
                submitBtn.className = 'btn btn-primary';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ–¥–ø–∏—Å–∫–∏
        const subscriptionForm = document.getElementById('subscription-form');
        if (subscriptionForm) {
            subscriptionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const data = {
                    tg_id: parseInt(formData.get('tg_id')),
                    action: formData.get('action'),
                    days: formData.get('action') !== 'remove' ? parseInt(formData.get('days')) : null,
                    reason: formData.get('reason')
                };
                
                try {
                    const response = await fetch('/admin/web/users/subscription', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        closeModal('modal-subscription');
                        window.location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏');
                }
            });
        }
        
        document.querySelectorAll('.modal-form').forEach(f => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ–¥–ø–∏—Å–∫–∏, —É –Ω–µ—ë —Å–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            if (f.id === 'subscription-form') return;
            
            f.addEventListener('submit', (e) => {
                const reasonInput = f.querySelector('input[name="reason"]');
                // –î–ª—è —Ñ–æ—Ä–º –±–µ–∑ –ø–æ–ª—è reason –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è)
                if (reasonInput && !reasonInput.value.trim()) {
                    e.preventDefault();
                    alert('–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É.');
                    return;
                }
            });
        });

        // AJAX –∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
        const userId = {{ user.tg_id }};
        let currentLogsPage = {{ logs_page or 1 }};
        
        function loadLogsPage(page) {
            if (page < 1) return;
            currentLogsPage = page;
            const container = document.getElementById('logs-container');
            const tbody = document.getElementById('logs-tbody');
            const pagination = document.getElementById('logs-pagination');
            const empty = document.getElementById('logs-empty');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            if (pagination) pagination.style.opacity = '0.5';
            
            const actionFilter = document.getElementById('logs-filter-action')?.value || 'all';
            fetch(`/admin/web/api/users/${userId}/logs?page=${page}&action=${actionFilter}`)
                .then(res => res.json())
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                    if (data.logs && data.logs.length > 0) {
                        if (empty) empty.style.display = 'none';
                        if (!tbody) {
                            // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                            const table = document.createElement('table');
                            table.id = 'logs-table';
                            table.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                        <th>–ê–¥–º–∏–Ω</th>
                                        <th>–î–µ—Ç–∞–ª–∏</th>
                                        <th>–í—Ä–µ–º—è (–ú–°–ö)</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-tbody"></tbody>
                            `;
                            container.insertBefore(table, pagination || empty);
                        }
                        const newTbody = document.getElementById('logs-tbody');
                        const criticalActions = ['user_blocked', 'user_unblocked', 'balance_credited', 'role_changed'];
                        const warningActions = ['ticket_created', 'subscription_created'];
                        newTbody.innerHTML = data.logs.map(log => {
                            const isCritical = criticalActions.includes(log.action);
                            const isWarning = warningActions.includes(log.action);
                            const rowClass = isCritical ? 'log-row-critical' : (isWarning ? 'log-row-warning' : '');
                            const badgeClass = isCritical ? 'badge-critical' : (isWarning ? 'badge-warning' : 'badge-info');
                            return `
                                <tr class="${rowClass}">
                                    <td>${log.id}</td>
                                    <td><span class="badge ${badgeClass}">${log.action}</span></td>
                                    <td>${log.admin_tg_id || '‚Äî'}</td>
                                    <td>${log.details || '‚Äî'}</td>
                                    <td>${log.created_at}</td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        if (tbody) tbody.innerHTML = '';
                        if (empty) {
                            empty.style.display = 'block';
                            empty.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π';
                        } else {
                            const emptyDiv = document.createElement('div');
                            emptyDiv.className = 'muted';
                            emptyDiv.id = 'logs-empty';
                            emptyDiv.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π';
                            container.appendChild(emptyDiv);
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                    if (pagination) {
                        pagination.innerHTML = '';
                        if (data.has_prev) {
                            const prevBtn = document.createElement('button');
                            prevBtn.className = 'btn btn-muted';
                            prevBtn.textContent = '‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è';
                            prevBtn.onclick = () => loadLogsPage(page - 1);
                            pagination.appendChild(prevBtn);
                        }
                        if (data.has_next) {
                            const nextBtn = document.createElement('button');
                            nextBtn.className = 'btn btn-muted';
                            nextBtn.textContent = '–°–ª–µ–¥—É—é—â–∞—è ‚Üí';
                            nextBtn.onclick = () => loadLogsPage(page + 1);
                            pagination.appendChild(nextBtn);
                        }
                        pagination.style.opacity = '1';
                    } else if (data.has_prev || data.has_next) {
                        // –°–æ–∑–¥–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                        const newPagination = document.createElement('div');
                        newPagination.id = 'logs-pagination';
                        newPagination.style.marginTop = '12px';
                        newPagination.style.display = 'flex';
                        newPagination.style.gap = '8px';
                        if (data.has_prev) {
                            const prevBtn = document.createElement('button');
                            prevBtn.className = 'btn btn-muted';
                            prevBtn.textContent = '‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è';
                            prevBtn.onclick = () => loadLogsPage(page - 1);
                            newPagination.appendChild(prevBtn);
                        }
                        if (data.has_next) {
                            const nextBtn = document.createElement('button');
                            nextBtn.className = 'btn btn-muted';
                            nextBtn.textContent = '–°–ª–µ–¥—É—é—â–∞—è ‚Üí';
                            nextBtn.onclick = () => loadLogsPage(page + 1);
                            newPagination.appendChild(nextBtn);
                        }
                        container.appendChild(newPagination);
                    }
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É —Å–µ–∫—Ü–∏–∏ –ª–æ–≥–æ–≤
                    document.getElementById('logs-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', err);
                    if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
                    if (pagination) pagination.style.opacity = '1';
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        let currentPaymentsPage = 1;
        const paymentsPerPage = 20;
        
        function loadPayments(page = 1) {
            currentPaymentsPage = page;
            const container = document.getElementById('payments-container');
            if (container) {
                container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            }
            
            fetch(`/users/${userId}/payments?limit=200`)
                .then(res => res.json())
                .then(allPayments => {
                    const countEl = document.getElementById('payments-count');
                    if (countEl) {
                        countEl.textContent = allPayments.length || 0;
                    }
                    
                    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
                    const totalPages = Math.ceil(allPayments.length / paymentsPerPage);
                    const startIdx = (page - 1) * paymentsPerPage;
                    const endIdx = startIdx + paymentsPerPage;
                    const payments = allPayments.slice(startIdx, endIdx);
                    
                    if (payments && payments.length > 0) {
                        const table = document.createElement('table');
                        table.style.marginTop = '12px';
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–í–∞–ª—é—Ç–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–°–æ–∑–¥–∞–Ω</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payments.map(payment => {
                                    const statusBadge = payment.status === 'succeeded' ? 'badge-payment-success' : 
                                                       payment.status === 'pending' ? 'badge-payment-pending' : 
                                                       'badge-payment-failed';
                                    const rowClass = payment.status === 'succeeded' ? 'row-payment-success' : 
                                                   payment.status === 'pending' ? 'row-payment-pending' : 
                                                   'row-payment-failed';
                                    const statusText = payment.status === 'succeeded' ? '–£—Å–ø–µ—à–Ω–æ' : 
                                                      payment.status === 'pending' ? '–û–∂–∏–¥–∞–Ω–∏–µ' : 
                                                      payment.status === 'failed' ? '–û—à–∏–±–∫–∞' : payment.status;
                                    const amountRub = (payment.amount_cents / 100).toFixed(2);
                                    return `
                                        <tr class="clickable ${rowClass}" style="cursor:pointer;" onclick="showPaymentDetail(${payment.id})">
                                            <td>${payment.id}</td>
                                            <td>${payment.provider || '‚Äî'}</td>
                                            <td>${amountRub} RUB</td>
                                            <td>${payment.currency || '‚Äî'}</td>
                                            <td><span class="badge ${statusBadge}">${statusText}</span></td>
                                            <td>${payment.created_at || '‚Äî'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        `;
                        
                        container.innerHTML = '';
                        container.appendChild(table);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                        if (totalPages > 1) {
                            const pagination = document.createElement('div');
                            pagination.style.marginTop = '12px';
                            pagination.style.display = 'flex';
                            pagination.style.gap = '8px';
                            pagination.style.justifyContent = 'center';
                            pagination.style.alignItems = 'center';
                            
                            if (page > 1) {
                                const prevBtn = document.createElement('button');
                                prevBtn.className = 'btn btn-muted';
                                prevBtn.textContent = '‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è';
                                prevBtn.onclick = () => loadPayments(page - 1);
                                pagination.appendChild(prevBtn);
                            }
                            
                            const pageInfo = document.createElement('span');
                            pageInfo.className = 'muted';
                            pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page} –∏–∑ ${totalPages}`;
                            pagination.appendChild(pageInfo);
                            
                            if (page < totalPages) {
                                const nextBtn = document.createElement('button');
                                nextBtn.className = 'btn btn-muted';
                                nextBtn.textContent = '–°–ª–µ–¥—É—é—â–∞—è ‚Üí';
                                nextBtn.onclick = () => loadPayments(page + 1);
                                pagination.appendChild(nextBtn);
                            }
                            
                            container.appendChild(pagination);
                        }
                    } else {
                        container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</div>';
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:', err);
                    const container = document.getElementById('payments-container');
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                    }
                });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞
        function showPaymentDetail(paymentId) {
            fetch(`/api/payments/${paymentId}`)
                .then(res => res.json())
                .then(payment => {
                    const content = document.getElementById('payment-detail-content');
                    const amountRub = (payment.amount_cents / 100).toFixed(2);
                    const statusBadge = payment.status === 'succeeded' ? 'badge-success' : 
                                       payment.status === 'pending' ? 'badge-payment-pending' : 
                                       'badge-payment-failed';
                    const statusText = payment.status === 'succeeded' ? '–£—Å–ø–µ—à–Ω–æ' : 
                                      payment.status === 'pending' ? '–û–∂–∏–¥–∞–Ω–∏–µ' : 
                                      payment.status === 'failed' ? '–û—à–∏–±–∫–∞' : payment.status;
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª–µ–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ raw_response
                    let extraInfo = '';
                    let rawResponseData = null;
                    
                    if (payment.raw_response) {
                        try {
                            rawResponseData = JSON.parse(payment.raw_response);
                            
                            // –î–ª—è CryptoBot
                            if (payment.provider === 'cryptobot' && rawResponseData) {
                                const invoice = rawResponseData.invoice || rawResponseData.result || rawResponseData;
                                if (invoice) {
                                    extraInfo += `
                                        <div class="card">
                                            <div class="label">Invoice ID</div>
                                            <div class="value">${invoice.invoice_id || invoice.id || '‚Äî'}</div>
                                        </div>
                                    `;
                                    if (invoice.paid_at) {
                                        extraInfo += `
                                            <div class="card">
                                                <div class="label">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</div>
                                                <div class="value">${new Date(invoice.paid_at).toLocaleString('ru-RU')}</div>
                                            </div>
                                        `;
                                    }
                                    if (invoice.paid_amount) {
                                        extraInfo += `
                                            <div class="card">
                                                <div class="label">–û–ø–ª–∞—á–µ–Ω–æ</div>
                                                <div class="value">${invoice.paid_amount} ${invoice.paid_asset || invoice.asset || ''}</div>
                                            </div>
                                        `;
                                    }
                                    if (invoice.fee_amount) {
                                        extraInfo += `
                                            <div class="card">
                                                <div class="label">–ö–æ–º–∏—Å—Å–∏—è</div>
                                                <div class="value">${invoice.fee_amount} ${invoice.fee_asset || ''}</div>
                                            </div>
                                        `;
                                    }
                                    if (invoice.bot_invoice_url || invoice.pay_url) {
                                        const invoiceUrl = invoice.bot_invoice_url || invoice.pay_url;
                                        extraInfo += `
                                            <div class="card">
                                                <div class="label">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å</div>
                                                <div class="value"><a href="${invoiceUrl}" target="_blank" style="color: #667eea; text-decoration: none; word-break: break-all;">${invoiceUrl}</a></div>
                                            </div>
                                        `;
                                    }
                                }
                            }
                            
                            // –î–ª—è Telegram Stars
                            if (payment.provider === 'telegram_stars' && rawResponseData) {
                                if (rawResponseData.telegram_payment_charge_id) {
                                    extraInfo += `
                                        <div class="card">
                                            <div class="label">Telegram Charge ID</div>
                                            <div class="value">${rawResponseData.telegram_payment_charge_id}</div>
                                        </div>
                                    `;
                                }
                                if (rawResponseData.provider_payment_charge_id) {
                                    extraInfo += `
                                        <div class="card">
                                            <div class="label">Provider Charge ID</div>
                                            <div class="value">${rawResponseData.provider_payment_charge_id}</div>
                                        </div>
                                    `;
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing raw_response:', e);
                        }
                    }
                    
                    content.innerHTML = `
                        <div style="display: grid; gap: 12px;">
                            <div class="card">
                                <div class="label">ID –ø–ª–∞—Ç–µ–∂–∞</div>
                                <div class="value">${payment.id}</div>
                            </div>
                            <div class="card">
                                <div class="label">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</div>
                                <div class="value">${payment.provider || '‚Äî'}</div>
                            </div>
                            <div class="card">
                                <div class="label">–°—É–º–º–∞</div>
                                <div class="value">${amountRub} RUB</div>
                            </div>
                            <div class="card">
                                <div class="label">–í–∞–ª—é—Ç–∞</div>
                                <div class="value">${payment.currency || '‚Äî'}</div>
                            </div>
                            <div class="card">
                                <div class="label">–°—Ç–∞—Ç—É—Å</div>
                                <div class="value"><span class="badge ${statusBadge}">${statusText}</span></div>
                            </div>
                            <div class="card">
                                <div class="label">External ID</div>
                                <div class="value">${payment.external_id || '‚Äî'}</div>
                            </div>
                            <div class="card">
                                <div class="label">–°–æ–∑–¥–∞–Ω</div>
                                <div class="value">${payment.created_at || '‚Äî'}</div>
                            </div>
                            ${extraInfo}
                            ${payment.raw_response ? `
                            <div class="card">
                                <div class="label" style="cursor: pointer; user-select: none;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.textContent = this.nextElementSibling.style.display === 'none' ? 'Raw Response (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)' : 'Raw Response (—Å–≤–µ—Ä–Ω—É—Ç—å)'">
                                    Raw Response (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                                </div>
                                <div class="value" style="font-family: monospace; font-size: 0.75em; word-break: break-all; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 8px; border-radius: 4px; display: none;">
                                    <pre style="margin: 0; white-space: pre-wrap;">${JSON.stringify(rawResponseData || JSON.parse(payment.raw_response), null, 2)}</pre>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    openModal('modal-payment-detail');
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø–ª–∞—Ç–µ–∂–∞:', err);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø–ª–∞—Ç–µ–∂–∞');
                });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function loadPaymentsCount() {
            fetch(`/users/${userId}/payments?limit=200`)
                .then(res => res.json())
                .then(allPayments => {
                    const countEl = document.getElementById('payments-count');
                    if (countEl) {
                        countEl.textContent = allPayments.length || 0;
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–ª–∞—Ç–µ–∂–µ–π:', err);
                    const countEl = document.getElementById('payments-count');
                    if (countEl) {
                        countEl.textContent = '‚Äî';
                    }
                });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const paymentsModal = document.getElementById('modal-payments');
        if (paymentsModal) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ 'show'
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (paymentsModal.classList.contains('show')) {
                            loadPayments(1); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        }
                    }
                });
            });
            observer.observe(paymentsModal, { attributes: true });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadPaymentsCount();
            });
        } else {
            loadPaymentsCount();
        }
    </script>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-overlay show" id="loading-overlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
    
    <script>
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–≤–µ—Ä–ª–µ–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
        (function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            
            function hideOverlay() {
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('show');
                    document.body.classList.remove('loading');
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideOverlay);
            } else {
                hideOverlay();
            }
            
            window.addEventListener('load', hideOverlay);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥ (–∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –∫—ç—à–∞)
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    hideOverlay();
                }
            });
            
            document.addEventListener('DOMContentLoaded', function() {
                const links = document.querySelectorAll('a[href^="/admin/web"]');
                
                links.forEach(link => {
                    link.addEventListener('click', function(e) {
                        if (this.hasAttribute('download') || this.target === '_blank' || this.href.includes('/download')) {
                            if (loadingOverlay) {
                                loadingOverlay.classList.remove('show');
                                document.body.classList.remove('loading');
                            }
                            return;
                        }
                        if (loadingOverlay) {
                            loadingOverlay.classList.add('show');
                            document.body.classList.add('loading');
                        }
                    });
                });
                
                document.addEventListener('click', function(e) {
                    const target = e.target.closest('a[href*="/download"]');
                    if (target && loadingOverlay) {
                        loadingOverlay.classList.remove('show');
                        document.body.classList.remove('loading');
                    }
                });
                
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    form.addEventListener('submit', function() {
                        if (loadingOverlay) {
                            loadingOverlay.classList.add('show');
                            document.body.classList.add('loading');
                        }
                    });
                });
            });
        })();
    </script>
</body>
</html>

