<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="icon" type="image/png" href="/static/images/logo.png">
    <link rel="shortcut icon" type="image/png" href="/static/images/logo.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.2));
        }
        .header-title h1 { font-size: 2em; margin: 0; }
        .header-actions { display: flex; gap: 10px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary:hover { background: rgba(255, 255, 255, 0.3); }
        /* –ö–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ (–Ω–µ –≤ header) */
        .content .btn-primary {
            background: #667eea;
            color: white;
            border: none;
        }
        .content .btn-primary:hover {
            background: #5568d3;
        }
        /* –ö–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
        .modal-content .btn-primary {
            background: #667eea;
            color: white;
            border: none;
        }
        .modal-content .btn-primary:hover {
            background: #5568d3;
        }
        .content { padding: 24px; }
        .servers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .server-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #eef1f5;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .server-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .server-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }
        .server-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-online {
            background: #d4edda;
            color: #155724;
        }
        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }
        .status-unknown {
            background: #e2e3e5;
            color: #383d41;
        }
        .server-info {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            color: #555;
            font-size: 0.9em;
        }
        .info-label { font-weight: 600; }
        .server-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        .btn-edit { 
            background: #667eea; 
            color: white; 
            border: none;
        }
        .btn-edit:hover { 
            background: #5568d3; 
        }
        .btn-delete { 
            background: #dc3545; 
            color: white; 
            border: none;
        }
        .btn-delete:hover { 
            background: #c82333; 
        }
        .btn-toggle { 
            background: #28a745; 
            color: white; 
            border: none;
        }
        .btn-toggle:hover { 
            background: #218838; 
        }
        .btn-toggle.disabled { 
            background: #6c757d; 
        }
        .btn-toggle.disabled:hover { 
            background: #5a6268; 
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .close:hover { color: #333; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-brand">
                <img src="/static/images/logo.png" alt="fioreVPN" class="header-logo" onerror="this.style.display='none';">
                <div class="header-title">
                    <h1>üñ•Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏</h1>
                </div>
            </div>
            <div class="header-actions">
                <a href="/admin/web/dashboard" class="btn btn-primary">‚Üê –ù–∞–∑–∞–¥</a>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
            </div>
        </div>

        <div class="content">
            {% if servers %}
                <div class="servers-grid">
                    {% for item in servers %}
                        {% set server = item.server %}
                        {% set status = item.status %}
                        <div class="server-card" data-server-id="{{ server.id }}" onclick="openServerDetails({{ server.id }}, event)" style="cursor: pointer;">
                            <div class="server-header">
                                <div class="server-name">{{ server.name }}</div>
                                <span class="server-status {% if status and status.is_online %}status-online{% elif status and not status.is_online %}status-offline{% else %}status-unknown{% endif %}">
                                    {% if status and status.is_online %}üü¢ –û–Ω–ª–∞–π–Ω{% elif status and not status.is_online %}üî¥ –û—Ñ—Ñ–ª–∞–π–Ω{% else %}‚ö™ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ{% endif %}
                                </span>
                            </div>
                            <div class="server-info">
                                <div class="info-row">
                                    <span class="info-label">Host:</span>
                                    <span>{{ server.host }}</span>
                                </div>
                                {% if server.location %}
                                <div class="info-row">
                                    <span class="info-label">–õ–æ–∫–∞—Ü–∏—è:</span>
                                    <span>{{ server.location }}</span>
                                </div>
                                {% endif %}
                                <div class="info-row">
                                    <span class="info-label">–ü–æ—Ä—Ç:</span>
                                    <span>{{ server.xray_port or 443 }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ü—Ä–æ—Ç–æ–∫–æ–ª:</span>
                                    <span>{{ server.xray_network or 'tcp' }} / {{ server.xray_security or 'tls' }}</span>
                                </div>
                                {% if status and status.response_time_ms is not none %}
                                <div class="info-row">
                                    <span class="info-label">–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞:</span>
                                    <span>{{ status.response_time_ms }} –º—Å</span>
                                </div>
                                {% endif %}
                                <div class="info-row">
                                    <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                                    <span>{% if server.is_enabled %}‚úÖ –í–∫–ª—é—á–µ–Ω{% else %}‚ùå –í—ã–∫–ª—é—á–µ–Ω{% endif %}</span>
                                </div>
                            </div>
                            {% if status and status.checked_at %}
                            <div class="info-row" style="margin-top: 10px; font-size: 0.8em; color: #999;">
                                <span>–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:</span>
                                <span id="last-check-{{ server.id }}" data-checked-at="{{ status.checked_at.isoformat() if status.checked_at else '' }}">
                                    {% if status.checked_at %}
                                        <script>
                                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                                            (function() {
                                                try {
                                                    const el = document.getElementById('last-check-{{ server.id }}');
                                                    if (el && el.dataset.checkedAt) {
                                                        const date = new Date(el.dataset.checkedAt);
                                                        // –í—Ä–µ–º—è –≤ UTC –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MSK (UTC+3)
                                                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Intl.DateTimeFormat –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
                                                        const formatter = new Intl.DateTimeFormat('ru-RU', {
                                                            timeZone: 'Europe/Moscow',
                                                            hour: '2-digit',
                                                            minute: '2-digit',
                                                            second: '2-digit',
                                                            hour12: false
                                                        });
                                                        el.textContent = formatter.format(date);
                                                    }
                                                } catch (e) {
                                                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏:', e);
                                                }
                                            })();
                                        </script>
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </span>
                            </div>
                            {% endif %}
                            <div class="server-actions">
                                <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); checkServer({{ server.id }}, event);" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                                <button class="btn btn-edit btn-small" onclick="event.stopPropagation(); openEditModal({{ server.id }});">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button class="btn btn-toggle btn-small {% if not server.is_enabled %}disabled{% endif %}" onclick="event.stopPropagation(); toggleServer({{ server.id }}, {{ 'false' if server.is_enabled else 'true' }});">
                                    {% if server.is_enabled %}‚è∏Ô∏è –í—ã–∫–ª—é—á–∏—Ç—å{% else %}‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å{% endif %}
                                </button>
                                <button class="btn btn-delete btn-small" onclick="event.stopPropagation(); deleteServer({{ server.id }});">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤</h3>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="serverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="serverForm" onsubmit="saveServer(event)">
                <input type="hidden" id="serverId" name="server_id">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label>Host (IP –∏–ª–∏ –¥–æ–º–µ–Ω) *</label>
                    <input type="text" id="host" name="host" required>
                </div>
                <div class="form-group">
                    <label>–õ–æ–∫–∞—Ü–∏—è</label>
                    <input type="text" id="location" name="location" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã">
                </div>
                <div class="form-group">
                    <label>–ü–æ—Ä—Ç Xray</label>
                    <input type="number" id="xray_port" name="xray_port" value="443">
                </div>
                <div class="form-group">
                    <label>3x-UI API URL</label>
                    <input type="text" id="x3ui_api_url" name="x3ui_api_url" placeholder="http://147.45.50.129:2053/panel/api">
                    <small style="color: #666; font-size: 0.85em;">URL API 3x-UI –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: http://IP:2053/panel/api)</small>
                </div>
                <div class="form-group">
                    <label>3x-UI Username</label>
                    <input type="text" id="x3ui_username" name="x3ui_username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>3x-UI Password</label>
                    <input type="password" id="x3ui_password" name="x3ui_password" placeholder="–≤–∞—à –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="form-group">
                    <label>Inbound ID –≤ 3x-UI</label>
                    <input type="number" id="x3ui_inbound_id" name="x3ui_inbound_id" placeholder="1">
                    <small style="color: #666; font-size: 0.85em;">ID Inbound –≤ 3x-UI, –≥–¥–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∫–ª–∏–µ–Ω—Ç—ã</small>
                </div>
                <div class="form-group">
                    <label>Network</label>
                    <select id="xray_network" name="xray_network">
                        <option value="tcp">TCP</option>
                        <option value="grpc" selected>gRPC</option>
                        <option value="ws">WebSocket</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Security</label>
                    <select id="xray_security" name="xray_security">
                        <option value="tls">TLS</option>
                        <option value="reality" selected>Reality</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>SNI</label>
                    <input type="text" id="xray_sni" name="xray_sni" placeholder="www.google.com">
                </div>
                <div class="form-group">
                    <label>Reality Public Key</label>
                    <input type="text" id="xray_reality_public_key" name="xray_reality_public_key">
                </div>
                <div class="form-group">
                    <label>Reality Short ID</label>
                    <input type="text" id="xray_reality_short_id" name="xray_reality_short_id">
                </div>
                <div class="form-group">
                    <label>Path (–¥–ª—è gRPC/WebSocket)</label>
                    <input type="text" id="xray_path" name="xray_path" placeholder="grpc –∏–ª–∏ /vless-ws">
                </div>
                <div class="form-group">
                    <label>Host Header (–¥–ª—è WebSocket)</label>
                    <input type="text" id="xray_host" name="xray_host">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()" style="background: #6c757d; color: white;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ -->
    <div id="serverDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="serverDetailsTitle">–î–µ—Ç–∞–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞</h2>
                <span class="close" onclick="closeServerDetailsModal()">&times;</span>
            </div>
            <div id="serverDetailsContent" style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <div class="info-row" style="margin-bottom: 10px;">
                        <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                        <span id="detailsStatus" class="server-status">‚Äî</span>
                    </div>
                    <div class="info-row" style="margin-bottom: 10px;">
                        <span class="info-label">Host:</span>
                        <span id="detailsHost">‚Äî</span>
                    </div>
                    <div class="info-row" style="margin-bottom: 10px;">
                        <span class="info-label">–ü–æ—Ä—Ç:</span>
                        <span id="detailsPort">‚Äî</span>
                    </div>
                    <div class="info-row" style="margin-bottom: 10px;">
                        <span class="info-label">–ü—Ä–æ—Ç–æ–∫–æ–ª:</span>
                        <span id="detailsProtocol">‚Äî</span>
                    </div>
                    <div class="info-row" style="margin-bottom: 10px;">
                        <span class="info-label">–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:</span>
                        <span id="detailsLastCheck">‚Äî</span>
                    </div>
                    <div class="info-row" style="margin-bottom: 10px;">
                        <span class="info-label">–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞:</span>
                        <span id="detailsResponseTime">‚Äî</span>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3 style="margin-bottom: 10px;">–ì—Ä–∞—Ñ–∏–∫ –ø–∏–Ω–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –ø—Ä–æ–≤–µ—Ä–æ–∫)</h3>
                    <canvas id="pingChart" width="800" height="300" style="max-width: 100%; height: auto;"></canvas>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="checkServerFromDetails()">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                    <button class="btn btn-primary" id="x3uiButton" onclick="openX3UI()" style="display: none;">üîó –û—Ç–∫—Ä—ã—Ç—å 3x-UI</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const csrfToken = "{{ csrf_token }}";
        
        function openAddModal() {
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä';
            document.getElementById('serverForm').reset();
            document.getElementById('serverId').value = '';
            document.getElementById('serverModal').style.display = 'block';
        }
        
        function openEditModal(serverId) {
            fetch(`/admin/web/api/servers`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (!data || !data.servers) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    }
                    const server = data.servers.find(s => s.id === serverId);
                    if (!server) {
                        alert('–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                    document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä';
                    
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    const setValue = (id, value) => {
                        const el = document.getElementById(id);
                        if (!el) {
                            console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å id="${id}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                            return;
                        }
                        try {
                            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                                el.value = (value != null && value !== undefined) ? String(value) : '';
                            } else if (el.tagName === 'SELECT') {
                                el.value = (value != null && value !== undefined) ? String(value) : '';
                            } else {
                                console.warn(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è id="${id}": ${el.tagName}`);
                            }
                        } catch (e) {
                            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è id="${id}":`, e);
                        }
                    };
                    
                    setValue('serverId', server.id);
                    setValue('name', server.name);
                    setValue('host', server.host);
                    setValue('location', server.location);
                    setValue('xray_port', server.xray_port || 443);
                    setValue('xray_uuid', server.xray_uuid);
                    setValue('xray_network', server.xray_network || 'tcp');
                    setValue('xray_security', server.xray_security || 'tls');
                    setValue('xray_sni', server.xray_sni);
                    setValue('xray_reality_public_key', server.xray_reality_public_key);
                    setValue('xray_reality_short_id', server.xray_reality_short_id);
                    setValue('xray_path', server.xray_path);
                    setValue('xray_host', server.xray_host);
                    setValue('x3ui_api_url', server.x3ui_api_url);
                    setValue('x3ui_username', server.x3ui_username);
                    setValue('x3ui_password', server.x3ui_password);
                    setValue('x3ui_inbound_id', server.x3ui_inbound_id);
                    
                    document.getElementById('serverModal').style.display = 'block';
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞:', err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞: ' + err.message);
                });
        }
        
        function closeModal() {
            document.getElementById('serverModal').style.display = 'none';
        }
        
        function saveServer(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const serverId = formData.get('server_id');
            const data = Object.fromEntries(formData);
            delete data.server_id;
            
            const url = serverId 
                ? `/admin/web/api/servers/${serverId}`
                : '/admin/web/api/servers';
            const method = serverId ? 'PUT' : 'POST';
            
            fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => {
                closeModal();
                location.reload();
            })
            .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
        }
        
        function toggleServer(id, enabled) {
            // enabled –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ 'true' –∏–ª–∏ 'false'
            const isEnabled = enabled === 'true' || enabled === true;
            
            fetch(`/admin/web/api/servers/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_enabled: isEnabled })
            })
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP error! status: ${r.status}`);
                }
                return r.json();
            })
            .then(() => {
                location.reload();
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞: ' + err.message);
            });
        }
        
        function deleteServer(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')) return;
            fetch(`/admin/web/api/servers/${id}`, { method: 'DELETE' })
                .then(() => location.reload())
                .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è serverModal)
        document.addEventListener('click', function(event) {
            const serverModal = document.getElementById('serverModal');
            if (event.target == serverModal) {
                closeModal();
            }
        });
        
        function checkServer(serverId, evt) {
            const btn = evt?.target || document.querySelector(`button[onclick*="checkServer(${serverId})"]`);
            if (!btn) return;
            
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            fetch(`/admin/web/api/servers/${serverId}/check`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = originalText;
                if (data.status) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    location.reload();
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = originalText;
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + err.message);
            });
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            fetch('/admin/web/api/servers')
                .then(r => r.json())
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å–µ—Ä–≤–µ—Ä–æ–≤ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    data.servers.forEach(server => {
                        const statusEl = document.querySelector(`[data-server-id="${server.id}"] .server-status`);
                        if (statusEl && server.status) {
                            statusEl.className = `server-status ${server.status.is_online ? 'status-online' : 'status-offline'}`;
                            statusEl.textContent = server.status.is_online ? 'üü¢ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ—Ñ–ª–∞–π–Ω';
                            
                            const lastCheckEl = document.getElementById(`last-check-${server.id}`);
                            if (lastCheckEl && server.status && server.status.checked_at) {
                                try {
                                    const date = new Date(server.status.checked_at);
                                    // –í—Ä–µ–º—è –≤ UTC –∏–∑ API, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MSK (UTC+3)
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Intl.DateTimeFormat –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
                                    const formatter = new Intl.DateTimeFormat('ru-RU', {
                                        timeZone: 'Europe/Moscow',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit',
                                        hour12: false
                                    });
                                    lastCheckEl.textContent = formatter.format(date);
                                } catch (e) {
                                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏:', e);
                                }
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
                            if (server.status && server.status.response_time_ms != null) {
                                const serverCard = document.querySelector(`[data-server-id="${server.id}"]`);
                                if (serverCard) {
                                    const responseTimeRows = serverCard.querySelectorAll('.info-row');
                                    responseTimeRows.forEach(row => {
                                        const label = row.querySelector('.info-label');
                                        if (label && label.textContent.includes('–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞')) {
                                            const valueSpan = row.querySelector('span:last-child');
                                            if (valueSpan) {
                                                valueSpan.textContent = `${server.status.response_time_ms} –º—Å`;
                                            }
                                        }
                                    });
                                }
                            }
                        }
                    });
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err));
        }, 10000); // –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        
        let pingChart = null;
        let currentServerId = null;
        let currentServerData = null;
        
        function openServerDetails(serverId, event) {
            if (event) event.stopPropagation();
            currentServerId = serverId;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
            fetch(`/admin/web/api/servers`)
                .then(r => r.json())
                .then(data => {
                    const server = data.servers.find(s => s.id === serverId);
                    if (!server) {
                        alert('–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                    currentServerData = server;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    document.getElementById('serverDetailsTitle').textContent = server.name;
                    document.getElementById('detailsHost').textContent = server.host;
                    document.getElementById('detailsPort').textContent = server.xray_port || 443;
                    document.getElementById('detailsProtocol').textContent = `${server.xray_network || 'tcp'} / ${server.xray_security || 'tls'}`;
                    
                    const statusEl = document.getElementById('detailsStatus');
                    if (server.status) {
                        statusEl.className = `server-status ${server.status.is_online ? 'status-online' : 'status-offline'}`;
                        statusEl.textContent = server.status.is_online ? 'üü¢ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ—Ñ–ª–∞–π–Ω';
                        if (server.status.checked_at) {
                            const date = new Date(server.status.checked_at);
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MSK –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                            const formatter = new Intl.DateTimeFormat('ru-RU', {
                                timeZone: 'Europe/Moscow',
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: false
                            });
                            document.getElementById('detailsLastCheck').textContent = formatter.format(date);
                        }
                        document.getElementById('detailsResponseTime').textContent = 
                            server.status.response_time_ms != null ? `${server.status.response_time_ms} –º—Å` : '‚Äî';
                    } else {
                        statusEl.className = 'server-status status-unknown';
                        statusEl.textContent = '‚ö™ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É 3x-UI –µ—Å–ª–∏ –µ—Å—Ç—å URL
                    const x3uiBtn = document.getElementById('x3uiButton');
                    if (server.x3ui_api_url) {
                        x3uiBtn.style.display = 'inline-block';
                    } else {
                        x3uiBtn.style.display = 'none';
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ —Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫
                    loadServerHistory(serverId);
                    
                    document.getElementById('serverDetailsModal').style.display = 'block';
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞:', err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞');
                });
        }
        
        function closeServerDetailsModal() {
            document.getElementById('serverDetailsModal').style.display = 'none';
            if (pingChart) {
                pingChart.destroy();
                pingChart = null;
            }
        }
        
        function loadServerHistory(serverId) {
            fetch(`/admin/web/api/servers/${serverId}/history`)
                .then(r => r.json())
                .then(data => {
                    updatePingChart(data.history);
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:', err);
                });
        }
        
        function updatePingChart(history) {
            const ctx = document.getElementById('pingChart').getContext('2d');
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const labels = history.map(h => {
                if (!h.checked_at) return '';
                const date = new Date(h.checked_at);
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MSK –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                const formatter = new Intl.DateTimeFormat('ru-RU', {
                    timeZone: 'Europe/Moscow',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                return formatter.format(date);
            });
            
            const pingData = history.map(h => h.is_online && h.response_time_ms != null ? h.response_time_ms : null);
            const onlineData = history.map(h => h.is_online ? 1 : 0);
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (pingChart) {
                pingChart.destroy();
            }
            
            pingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–ü–∏–Ω–≥ (–º—Å)',
                            data: pingData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            spanGaps: true,
                        },
                        {
                            label: '–û–Ω–ª–∞–π–Ω (1=–¥–∞, 0=–Ω–µ—Ç)',
                            data: onlineData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            pointRadius: 2,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '–ü–∏–Ω–≥ (–º—Å)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '–û–Ω–ª–∞–π–Ω'
                            },
                            min: 0,
                            max: 1,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }
        
        function checkServerFromDetails() {
            if (!currentServerId) return;
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            fetch(`/admin/web/api/servers/${currentServerId}/check`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = originalText;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (data.status) {
                    const statusEl = document.getElementById('detailsStatus');
                    statusEl.className = `server-status ${data.status.is_online ? 'status-online' : 'status-offline'}`;
                    statusEl.textContent = data.status.is_online ? 'üü¢ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ—Ñ–ª–∞–π–Ω';
                    
                    if (data.status.checked_at) {
                        const date = new Date(data.status.checked_at);
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MSK –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                        const formatter = new Intl.DateTimeFormat('ru-RU', {
                            timeZone: 'Europe/Moscow',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                        document.getElementById('detailsLastCheck').textContent = formatter.format(date);
                    }
                    document.getElementById('detailsResponseTime').textContent = 
                        data.status.response_time_ms != null ? `${data.status.response_time_ms} –º—Å` : '‚Äî';
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                loadServerHistory(currentServerId);
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:', err);
                btn.disabled = false;
                btn.textContent = originalText;
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Ä–≤–µ—Ä–∞');
            });
        }
        
        function openX3UI() {
            if (!currentServerData || !currentServerData.x3ui_api_url) {
                alert('URL 3x-UI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞');
                return;
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º API URL –≤ URL –ø–∞–Ω–µ–ª–∏ (—É–±–∏—Ä–∞–µ–º /panel/api, –æ—Å—Ç–∞–≤–ª—è–µ–º /panel/)
            let panelUrl = currentServerData.x3ui_api_url;
            if (panelUrl.endsWith('/panel/api')) {
                panelUrl = panelUrl.replace('/panel/api', '/panel/');
            } else if (panelUrl.endsWith('/api')) {
                panelUrl = panelUrl.replace('/api', '/panel/');
            } else if (!panelUrl.endsWith('/panel/')) {
                panelUrl = panelUrl.replace(/\/$/, '') + '/panel/';
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            window.open(panelUrl, '_blank');
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è serverDetailsModal)
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('serverDetailsModal');
            if (event.target == modal) {
                closeServerDetailsModal();
            }
        });
    </script>
</body>
</html>

