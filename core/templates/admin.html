<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å fioreVPN</title>
    <link rel="stylesheet" href="/static/loading.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.2));
            animation: pulseLogo 3s ease-in-out infinite;
        }
        
        @keyframes pulseLogo {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.95; }
        }
        
        .header-title h1 {
            font-size: 2em;
            margin: 0;
        }
        
        .header h1 {
            font-size: 2em;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: #667eea;
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-active {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-superadmin { background: #ffd6e0; color: #a00036; }
        .badge-admin { background: #fff3cd; color: #856404; }
        .badge-moderator { background: #d1ecf1; color: #0c5460; }
        .badge-user { background: #e9ecef; color: #495057; }
        
        .tg-id {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #667eea;
        }
        
        .balance {
            font-weight: 600;
            color: #28a745;
        }
        
        .code {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        
        @media (max-width: 768px) {
            .table-container {
                padding: 15px;
            }
            
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 10px 5px;
            }
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .header-actions .btn-primary { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 16px;
            font-size: 0.9em;
        }
        .header-actions .btn-primary:hover { 
            background: rgba(255,255,255,0.3); 
        }
        .header-actions .btn-muted { 
            background: #e9ecef; 
            color: #333;
            padding: 10px 16px;
            font-size: 0.9em;
        }
        .header-actions .btn-muted:hover { 
            background: #dee2e6; 
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-muted { background: #e9ecef; color: #333; }

        .input {
            padding: 6px 8px;
            border: 1px solid #e1e5ea;
            border-radius: 8px;
            font-size: 0.9em;
            width: 110px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 16px 30px;
            background: #ffffff;
            border-bottom: 1px solid #eef1f5;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            color: #666;
            font-size: 0.95em;
        }
        
        .notifications-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .notifications-bell:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .notifications-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7em;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        
        .notification-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .notification-overlay.show {
            display: flex;
        }
        
        .notification-modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: min(600px, 90vw);
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }
        
        .notification-item {
            padding: 12px;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .notification-item.success {
            border-left-color: #28a745;
        }
        
        .notification-item.warning {
            border-left-color: #ffc107;
        }
        
        .notification-item.danger {
            border-left-color: #dc3545;
        }
        
        .notification-item.info {
            border-left-color: #17a2b8;
        }
        
        .alert-banner {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-banner.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        /* Modal –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 22px;
            width: min(440px, 92vw);
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }
        .modal h3 {
            margin: 0 0 12px;
        }
        body.backdrop-blur .container {
            filter: blur(4px);
        }
        
        .alert-banner.danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-banner.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .search {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-brand">
                <img src="/static/images/logo.png" alt="fioreVPN" class="header-logo" onerror="this.style.display='none';">
                <div class="header-title">
                    <h1>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
                </div>
            </div>
            <div class="header-actions">
                <div class="notifications-bell" id="notifications-bell" onclick="toggleNotifications()" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                    üîî
                    <span class="notifications-badge" id="notifications-badge" style="display:none;">0</span>
                </div>
                <a class="btn btn-primary" href="/admin/web/dashboard">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a class="btn btn-primary" href="/admin/web/users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                <a class="btn btn-primary" href="/admin/web/payments">üí≥ –ü–ª–∞—Ç–µ–∂–∏</a>
                <a class="btn btn-primary" href="/admin/web/tickets">üßæ –¢–∏–∫–µ—Ç—ã</a>
                <a class="btn btn-primary" href="/admin/web/logs">üìã –õ–æ–≥–∏</a>
                <a class="btn btn-primary" href="/admin/web/settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                <a class="btn btn-primary" href="/admin/web/promo-codes">üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã</a>
                <a class="btn btn-primary" href="/admin/web/subscription-plans">üì¶ –¢–∞—Ä–∏—Ñ—ã</a>
                <a class="btn btn-primary" href="/admin/web/backups">üíæ –ë—ç–∫–∞–ø—ã</a>
                <a class="btn btn-muted" href="/admin/users/export.csv">üì• CSV</a>
                <a class="btn btn-muted" href="/admin/users/export.xlsx">üìä Excel</a>
                <a class="btn btn-muted" href="/admin/logout">üö™ –í—ã–π—Ç–∏</a>
            </div>
        </div>

        <div class="topbar">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <form class="search" method="get" action="/admin/web/users" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <input class="input" style="width:200px" type="text" name="q" placeholder="–ü–æ–∏—Å–∫: tg_id, username, –∏–º—è" value="{{ q }}">
                    <select class="input" name="role" style="width:150px;">
                        <option value="all" {% if role_filter == 'all' %}selected{% endif %}>–í—Å–µ —Ä–æ–ª–∏</option>
                        <option value="superadmin" {% if role_filter == 'superadmin' %}selected{% endif %}>–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω</option>
                        <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω</option>
                        <option value="moderator" {% if role_filter == 'moderator' %}selected{% endif %}>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                        <option value="user" {% if role_filter == 'user' %}selected{% endif %}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                    </select>
                    <select class="input" name="reg_period" style="width:150px;">
                        <option value="all" {% if reg_filter == 'all' %}selected{% endif %}>–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</option>
                        <option value="today" {% if reg_filter == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="7d" {% if reg_filter == '7d' %}selected{% endif %}>7 –¥–Ω–µ–π</option>
                        <option value="30d" {% if reg_filter == '30d' %}selected{% endif %}>30 –¥–Ω–µ–π</option>
                    </select>
                    <input class="input" style="width:100px" type="number" step="0.01" name="balance_min" placeholder="–ë–∞–ª–∞–Ω—Å –æ—Ç" value="{{ balance_min }}">
                    <input class="input" style="width:100px" type="number" step="0.01" name="balance_max" placeholder="–ë–∞–ª–∞–Ω—Å –¥–æ" value="{{ balance_max }}">
                    <button class="btn btn-primary" type="submit">üîé –ù–∞–π—Ç–∏</button>
                </form>
                <a class="btn btn-muted" href="/admin/web/users" style="text-decoration:none;">‚úñ –°–±—Ä–æ—Å</a>
            </div>
        </div>
        
        <div class="stats">
            <a class="stat-card" id="stat-total" href="/admin/web/users?status=all{% if q %}&q={{ q }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if reg_filter %}&reg_period={{ reg_filter }}{% endif %}" style="text-decoration:none; color:inherit; border: 2px solid {% if status == 'all' %}#667eea{% else %}transparent{% endif %};">
                <h3 id="stat-total-value">{{ total_users }}</h3>
                <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            </a>
            <a class="stat-card" id="stat-active" href="/admin/web/users?status=active{% if q %}&q={{ q }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if reg_filter %}&reg_period={{ reg_filter }}{% endif %}" style="text-decoration:none; color:inherit; border: 2px solid {% if status == 'active' %}#667eea{% else %}transparent{% endif %};">
                <h3 id="stat-active-value">{{ total_active }}</h3>
                <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö</p>
            </a>
            <a class="stat-card" id="stat-blocked" href="/admin/web/users?status=blocked{% if q %}&q={{ q }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if reg_filter %}&reg_period={{ reg_filter }}{% endif %}" style="text-decoration:none; color:inherit; border: 2px solid {% if status == 'blocked' %}#667eea{% else %}transparent{% endif %};">
                <h3 id="stat-blocked-value">{{ total_blocked }}</h3>
                <p>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</p>
            </a>
        </div>
        
        <div class="table-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button class="btn btn-primary" id="select-all-btn" onclick="selectAllUsers()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-muted" id="deselect-all-btn" onclick="deselectAll()" style="display:none;">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
                    <span id="selected-count" style="color:#666; font-size:0.9em;"></span>
                </div>
                <div id="bulk-actions" style="display:none; flex-direction:row; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button class="btn btn-danger" onclick="openBulkModal('block')">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-success" onclick="openBulkModal('unblock')">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-primary" onclick="openBulkModal('credit')">üí∞ –ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width:40px;"><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()"></th>
                        <th>ID</th>
                        <th>–ò–º—è</th>
                        <th>–¢–µ–≥</th>
                        <th>tg_id</th>
                        <th>–†–æ–ª—å</th>
                        <th>–ë–∞–ª–∞–Ω—Å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                        <th>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</th>
                        <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    {% for user in users %}
                <tr class="row-link" data-href="/admin/web/users/{{ user.tg_id }}" data-user-id="{{ user.tg_id }}">
                        <td onclick="event.stopPropagation();"><input type="checkbox" class="user-checkbox" value="{{ user.tg_id }}" onchange="updateBulkActions()"></td>
                        <td>{{ user.id }}</td>
                        <td>{{ user.full_name }}</td>
                        <td>{{ user.tag }}</td>
                    <td class="tg-id">{{ user.tg_id }}</td>
                        <td>
                        {% set role_class = 'badge-user' %}
                        {% if user.role == '–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω' %}
                            {% set role_class = 'badge-superadmin' %}
                        {% elif user.role == '–ê–¥–º–∏–Ω' %}
                            {% set role_class = 'badge-admin' %}
                        {% elif user.role == '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' %}
                            {% set role_class = 'badge-moderator' %}
                        {% endif %}
                        <span class="badge {{ role_class }}">{{ user.role }}</span>
                        </td>
                    <td class="balance">{{ "%.2f"|format(user.balance) }} RUB</td>
                        <td>
                            <span class="badge {% if user.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                                {% if user.is_active %}‚úÖ –ê–∫—Ç–∏–≤–µ–Ω{% else %}‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge {% if user.has_active_subscription %}badge-active{% else %}badge-inactive{% endif %}">
                                {% if user.has_active_subscription %}‚úÖ –ï—Å—Ç—å{% else %}‚ùå –ù–µ—Ç{% endif %}
                            </span>
                        </td>
                        <td><span class="code">{{ user.referral_code }}</span></td>
                        <td>{{ user.created_at }} –ú–°–ö</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    

    <script>
        // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è CSRF-–∑–∞—â–∏—Ç–∞: –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ –≤—Å–µ–º POST —Ñ–æ—Ä–º–∞–º
        const csrfToken = "{{ csrf_token }}";
        document.querySelectorAll('form[method="post"]').forEach((form) => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–æ—Ä–º—É –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, —É –Ω–µ—ë —Å–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            if (form.id === 'bulk-action-form') {
                return;
            }
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    body: fd,
                    headers: { 'X-CSRF-Token': csrfToken }
                }).then(() => window.location.reload());
            });
        });

        // –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å)
        document.querySelectorAll('tr.row-link').forEach((row) => {
            const href = row.getAttribute('data-href');
            if (!href) return;
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => window.location = href);
        });

        // –ù–µ –¥–∞—ë–º –∫–ª–∏–∫—É –ø–æ –∏–Ω–ø—É—Ç–∞–º/–∫–Ω–æ–ø–∫–∞–º –≤ —Å—Ç—Ä–æ–∫–µ —É–≤–æ–¥–∏—Ç—å –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
        document.querySelectorAll('tr.row-link input, tr.row-link button, tr.row-link form').forEach((el) => {
            el.addEventListener('click', (e) => e.stopPropagation());
        });

        // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        let notificationsData = { notifications: [], alerts: [], unread_count: 0 };
        
        function loadNotifications() {
            fetch('/admin/web/api/notifications')
                .then(res => res.json())
                .then(data => {
                    notificationsData = data;
                    updateNotificationsUI();
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', err));
        }
        
        function updateNotificationsUI() {
            const badge = document.getElementById('notifications-badge');
            if (notificationsData.unread_count > 0) {
                badge.textContent = notificationsData.unread_count > 99 ? '99+' : notificationsData.unread_count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const container = document.getElementById('notifications-container');
            if (container) {
                container.innerHTML = '';
                
                // –ê–ª–µ—Ä—Ç—ã
                if (notificationsData.alerts && notificationsData.alerts.length > 0) {
                    const alertsDiv = document.createElement('div');
                    alertsDiv.style.marginBottom = '20px';
                    notificationsData.alerts.forEach(alert => {
                        const alertEl = document.createElement('div');
                        alertEl.className = `alert-banner ${alert.type}`;
                        alertEl.innerHTML = `
                            <strong>${alert.title}</strong>
                            <div>${alert.message}</div>
                        `;
                        alertsDiv.appendChild(alertEl);
                    });
                    container.appendChild(alertsDiv);
                }
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                if (notificationsData.notifications && notificationsData.notifications.length > 0) {
                    notificationsData.notifications.forEach(notif => {
                        const notifEl = document.createElement('div');
                        notifEl.className = `notification-item ${notif.severity}`;
                        notifEl.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <strong>${notif.title}</strong>
                                    <div style="margin-top:4px; color:#666; font-size:0.9em;">${notif.message}</div>
                                </div>
                                ${notif.count ? `<span style="background:#667eea; color:white; padding:2px 8px; border-radius:10px; font-size:0.8em;">${notif.count}</span>` : ''}
                            </div>
                            ${notif.link ? `<a href="${notif.link}" style="display:inline-block; margin-top:8px; color:#667eea; text-decoration:none; font-size:0.9em;">–ü–µ—Ä–µ–π—Ç–∏ ‚Üí</a>` : ''}
                        `;
                        container.appendChild(notifEl);
                    });
                } else if (notificationsData.alerts.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                }
            }
        }
        
        function toggleNotifications() {
            const overlay = document.getElementById('notifications-overlay');
            if (overlay) {
                overlay.classList.toggle('show');
                if (overlay.classList.contains('show')) {
                    loadNotifications();
                }
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadNotifications();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadNotifications, 30000);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            const overlay = document.getElementById('notifications-overlay');
            if (overlay && e.target === overlay) {
                overlay.classList.remove('show');
            }
        });

        // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –æ–≤–µ—Ä–ª–µ—è - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        function forceHideOverlay() {
            const overlays = document.querySelectorAll('.loading-overlay');
            overlays.forEach(overlay => {
                overlay.classList.remove('show');
                overlay.style.display = 'none';
                overlay.style.opacity = '0';
                overlay.style.pointerEvents = 'none';
            });
            document.body.classList.remove('loading');
            document.body.style.overflow = '';
            document.body.style.position = '';
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
        forceHideOverlay();
        
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ requestAnimationFrame
        requestAnimationFrame(function() {
            forceHideOverlay();
            requestAnimationFrame(forceHideOverlay);
        });

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function getRoleClass(role) {
            if (role === '–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω') return 'badge-superadmin';
            if (role === '–ê–¥–º–∏–Ω') return 'badge-admin';
            if (role === '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä') return 'badge-moderator';
            return 'badge-user';
        }
        
        function loadUsersTable() {
            const params = new URLSearchParams(window.location.search);
            const url = `/admin/web/api/users?${params.toString()}`;
            
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö (—ç—Ç–æ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
            // –û–≤–µ—Ä–ª–µ–π —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    const totalEl = document.getElementById('stat-total-value');
                    const activeEl = document.getElementById('stat-active-value');
                    const blockedEl = document.getElementById('stat-blocked-value');
                    if (totalEl) totalEl.textContent = data.total_users;
                    if (activeEl) activeEl.textContent = data.total_active;
                    if (blockedEl) blockedEl.textContent = data.total_blocked;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                    const tbody = document.getElementById('users-tbody');
                    if (tbody) {
                        tbody.innerHTML = data.users.map(user => {
                            const roleClass = getRoleClass(user.role);
                            return `
                                <tr class="row-link" data-href="/admin/web/users/${user.tg_id}" data-user-id="${user.tg_id}">
                                    <td onclick="event.stopPropagation();"><input type="checkbox" class="user-checkbox" value="${user.tg_id}" onchange="updateBulkActions()"></td>
                                    <td>${user.id}</td>
                                    <td>${user.full_name}</td>
                                    <td>${user.tag}</td>
                                    <td class="tg-id">${user.tg_id}</td>
                                    <td>
                                        <span class="badge ${roleClass}">${user.role}</span>
                                    </td>
                                    <td class="balance">${user.balance.toFixed(2)} RUB</td>
                                    <td>
                                        <span class="badge ${user.is_active ? 'badge-active' : 'badge-inactive'}">
                                            ${user.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${user.has_active_subscription ? 'badge-active' : 'badge-inactive'}">
                                            ${user.has_active_subscription ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}
                                        </span>
                                    </td>
                                    <td><span class="code">${user.referral_code}</span></td>
                                    <td>${user.created_at} –ú–°–ö</td>
                                </tr>
                            `;
                        }).join('');
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è —Å—Ç—Ä–æ–∫
                        document.querySelectorAll('tr.row-link').forEach((row) => {
                            const href = row.getAttribute('data-href');
                            if (!href) return;
                            row.style.cursor = 'pointer';
                            row.addEventListener('click', () => window.location = href);
                        });
                    }
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–≤–µ—Ä–ª–µ–π —Å–∫—Ä—ã—Ç (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω)
                    forceHideOverlay();
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
                    // –°–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    forceHideOverlay();
                });
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        // –ù–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function initUsersTable() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –æ–≤–µ—Ä–ª–µ–π —É—Å–ø–µ–ª —Å–∫—Ä—ã—Ç—å—Å—è
                    setTimeout(loadUsersTable, 200);
                });
            } else {
                // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                setTimeout(loadUsersTable, 200);
            }
        }
        
        initUsersTable();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        setInterval(loadUsersTable, 15000);

        // –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        function selectAllUsers() {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
            const checkbox = document.getElementById('select-all-checkbox');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            const isChecked = !allChecked; // –ï—Å–ª–∏ –≤—Å–µ –≤—ã–±—Ä–∞–Ω—ã, —Å–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä, –∏–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ–º –≤—Å–µ
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
            checkboxes.forEach(cb => cb.checked = isChecked);
            if (checkbox) {
                checkbox.checked = isChecked;
            }
            updateBulkActions();
            updateSelectButtons();
        }
        
        function toggleSelectAll() {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Ç–∞–±–ª–∏—Ü—ã
            const checkbox = document.getElementById('select-all-checkbox');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            const isChecked = checkbox.checked;
            
            checkboxes.forEach(cb => cb.checked = isChecked);
            updateBulkActions();
            updateSelectButtons();
        }
        
        function deselectAll() {
            document.getElementById('select-all-checkbox').checked = false;
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
            updateBulkActions();
            updateSelectButtons();
        }
        
        function updateSelectButtons() {
            const selected = document.querySelectorAll('.user-checkbox:checked').length;
            const selectAllBtn = document.getElementById('select-all-btn');
            const deselectAllBtn = document.getElementById('deselect-all-btn');
            if (selected > 0 && selectAllBtn && deselectAllBtn) {
                selectAllBtn.style.display = 'none';
                deselectAllBtn.style.display = 'inline-block';
            } else if (selectAllBtn && deselectAllBtn) {
                selectAllBtn.style.display = 'inline-block';
                deselectAllBtn.style.display = 'none';
            }
        }
        
        function updateBulkActions() {
            const selected = document.querySelectorAll('.user-checkbox:checked');
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (selected.length > 0) {
                if (bulkActions) {
                    bulkActions.style.display = 'flex';
                    bulkActions.style.flexDirection = 'row';
                }
                if (selectedCount) selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selected.length}`;
            } else {
                if (bulkActions) {
                    bulkActions.style.display = 'none';
                }
                if (selectedCount) selectedCount.textContent = '';
            }
            updateSelectButtons();
        }
        
        function getSelectedUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }
        
        function openBulkModal(action) {
            const selected = getSelectedUsers();
            if (selected.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                return;
            }
            
            const modal = document.getElementById('bulk-action-modal');
            const actionTitle = document.getElementById('bulk-action-title');
            const actionForm = document.getElementById('bulk-action-form');
            const actionInput = document.getElementById('bulk-action-type');
            
            if (!modal || !actionTitle || !actionForm || !actionInput) return;
            
            actionInput.value = action;
            if (action === 'block') {
                actionTitle.textContent = '–ú–∞—Å—Å–æ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
                actionForm.innerHTML = `
                    <input type="hidden" name="action" value="block">
                    <input type="hidden" name="user_ids" value="${selected.join(',')}">
                    <label style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞" style="width:100%; margin-bottom:14px;" required>
                    <div style="color:#666; font-size:0.9em; margin-bottom:14px;">–ë—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${selected.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="btn btn-muted" type="button" onclick="closeBulkModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-danger" type="submit">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                `;
            } else if (action === 'unblock') {
                actionTitle.textContent = '–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
                actionForm.innerHTML = `
                    <input type="hidden" name="action" value="unblock">
                    <input type="hidden" name="user_ids" value="${selected.join(',')}">
                    <label style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞" style="width:100%; margin-bottom:14px;" required>
                    <div style="color:#666; font-size:0.9em; margin-bottom:14px;">–ë—É–¥–µ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${selected.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="btn btn-muted" type="button" onclick="closeBulkModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" type="submit">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                `;
            } else if (action === 'credit') {
                actionTitle.textContent = '–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞';
                actionForm.innerHTML = `
                    <input type="hidden" name="action" value="credit">
                    <input type="hidden" name="user_ids" value="${selected.join(',')}">
                    <label style="display:block; margin-bottom:6px;">–°—É–º–º–∞ (RUB)</label>
                    <input class="input" type="number" step="0.01" name="amount" placeholder="+/- RUB" style="width:100%; margin-bottom:10px;" required>
                    <label style="display:block; margin-bottom:6px;">–ü—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input class="input" type="text" name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞" style="width:100%; margin-bottom:14px;" required>
                    <div style="color:#666; font-size:0.9em; margin-bottom:14px;">–ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω —É: ${selected.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="btn btn-muted" type="button" onclick="closeBulkModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                `;
            }
            
            modal.classList.add('show');
            document.body.classList.add('backdrop-blur');
        }
        
        function closeBulkModal() {
            const modal = document.getElementById('bulk-action-modal');
            if (modal) {
                modal.classList.remove('show');
                document.body.classList.remove('backdrop-blur');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        document.addEventListener('submit', (e) => {
            if (e.target.id === 'bulk-action-form') {
                e.preventDefault();
                const formData = new FormData(e.target);
                const action = formData.get('action');
                const userIds = formData.get('user_ids').split(',').map(id => parseInt(id));
                const reason = formData.get('reason');
                
                if (!reason || !reason.trim()) {
                    alert('–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É');
                    return;
                }
                
                let url = '';
                let payload = {};
                
                if (action === 'block') {
                    url = '/admin/web/users/bulk/block';
                    payload = { user_ids: userIds, reason: reason };
                } else if (action === 'unblock') {
                    url = '/admin/web/users/bulk/unblock';
                    payload = { user_ids: userIds, reason: reason };
                } else if (action === 'credit') {
                    url = '/admin/web/users/bulk/credit';
                    const amount = parseFloat(formData.get('amount'));
                    if (isNaN(amount)) {
                        alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞');
                        return;
                    }
                    payload = { user_ids: userIds, amount: amount, reason: reason };
                }
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        closeBulkModal();
                        deselectAll();
                        loadUsersTable();
                        alert(`–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.processed || userIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞:', err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏');
                });
            }
        });

    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <div class="overlay" id="bulk-action-modal">
        <div class="modal">
            <h3 id="bulk-action-title"></h3>
            <form id="bulk-action-form">
                <input type="hidden" id="bulk-action-type" name="action">
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="notification-overlay" id="notifications-overlay">
        <div class="notification-modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <button class="btn btn-muted" onclick="toggleNotifications()" style="padding:6px 12px;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div id="notifications-container">
                <div style="text-align:center; color:#666; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) -->
    <div class="loading-overlay show" id="loading-overlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
    
    <script>
        // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –æ–≤–µ—Ä–ª–µ—è - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        function forceHideOverlay() {
            const overlays = document.querySelectorAll('.loading-overlay');
            overlays.forEach(overlay => {
                overlay.classList.remove('show');
                overlay.style.display = 'none';
                overlay.style.opacity = '0';
                overlay.style.pointerEvents = 'none';
            });
            document.body.classList.remove('loading');
            document.body.style.overflow = '';
            document.body.style.position = '';
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        (function() {
            // –°–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // –î–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
            forceHideOverlay();
            
            // –ü–æ–≤—Ç–æ—Ä—è–µ–º —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ requestAnimationFrame
            requestAnimationFrame(function() {
                forceHideOverlay();
                requestAnimationFrame(forceHideOverlay);
            });
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å–ª–µ DOMContentLoaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    forceHideOverlay();
                    setTimeout(forceHideOverlay, 50);
                    setTimeout(forceHideOverlay, 100);
                });
            } else {
                setTimeout(forceHideOverlay, 50);
                setTimeout(forceHideOverlay, 100);
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)
                window.addEventListener('load', function() {
                forceHideOverlay();
                setTimeout(forceHideOverlay, 50);
            });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥ (–∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –∫—ç—à–∞)
            window.addEventListener('pageshow', function(event) {
                forceHideOverlay();
                setTimeout(forceHideOverlay, 50);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö –∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö
            document.addEventListener('DOMContentLoaded', function() {
                const links = document.querySelectorAll('a[href^="/admin/web"], a[href^="/admin/users"]');
                
                links.forEach(link => {
                    link.addEventListener('click', function(e) {
                        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –¥–ª—è —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                        if (this.hasAttribute('download') || this.target === '_blank' || this.href.includes('/download')) {
                            // –°–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω
                            if (loadingOverlay) {
                                loadingOverlay.classList.remove('show');
                                document.body.classList.remove('loading');
                            }
                            return;
                        }
                        if (loadingOverlay) {
                            loadingOverlay.classList.add('show');
                            document.body.classList.add('loading');
                        }
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
                document.addEventListener('click', function(e) {
                    const target = e.target.closest('a[href*="/download"]');
                    if (target) {
                        // –°—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                            if (loadingOverlay) {
                                loadingOverlay.classList.remove('show');
                            document.body.classList.remove('loading');
                            }
                    }
                });
                
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    form.addEventListener('submit', function() {
                        if (loadingOverlay) {
                            loadingOverlay.classList.add('show');
                            document.body.classList.add('loading');
                        }
                    });
                });
            });
        })();
    </script>
</body>
</html>

